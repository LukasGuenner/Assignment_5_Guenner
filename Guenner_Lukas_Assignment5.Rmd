---
title: "DSPM - Assignment 5"
author: 'Submitted by Lukas GÃ¼nner (Student-ID: 5393972)'
date: "02/10/2021"
output: 
  html_document:
    toc: True
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Working directory:
# Load project to obtain correct working directory

```
I worked together with Max Haberl (Student ID: 5407084). I hereby assure that my submission is in line with the *Code of Conduct* outlined on the lecture slides.

The working history for this assignment can be accessed via this link:

https://github.com/LukasGuenner/Assignment_5_Guenner.git


## Preparation

Before starting this assignment, I am clearing my workspace and console and then 
loading the packages, necessary to complete this assignment. 
```{r prep, message=FALSE}

rm(list = ls()); cat("\014")

library(tidyverse)
library(naniar)
library(dplyr)

```

## Getting to know the API

read documentation of the ticketmaster.com API

```{r key, message=F}

# loading API key from separate file 
source("ticketmasterKey.R")

```

Information on the API:

ATTENTION !!!
5000 API calls per day and rate limitation of 5 requests per second!
Deep Paging: we only support retrieving the 1000th item. i.e. ( size * page < 1000)

```{r key, message=F}

# information from the API documentation
root <- "https://app.ticketmaster.com/discovery/v2/"

```


## Interaction with the API - the basics


```{r libraries, message=F}

# loading required packages
if (!require("jsonlite")) install.packages("jsonlite")
if (!require("httr")) install.packages("httr")
if (!require("rlist")) install.packages("rlist")

library(jsonlite)
library(httr)
library(rlist)

```


Making the first API call to obtain venues in Germany

```{r basics, message=F}

country <- "DE"  # define country
countryLong <- "Germany"

# perform GET request
venuesResp <- GET(paste0(root, "venues?apikey=", mykey, 
                     "&locale=*&countryCode=", country)) %>%
  content()

# describe what you can see from the list obtained after the request


# subset list to venue data
subset <- venuesResp[["_embedded"]][["venues"]]

# initialize data frame to store information
venues <- data.frame(name = character(),
                     city = character(), 
                     adress = character(),
                     postalCode = integer(),
                     countryCode = character(),
                     url = character(),
                     longitude = numeric(),
                     latitude = numeric(),
                     stringsAsFactors=FALSE)

# extract data from list
for (i in 1:20){
  name <- subset[[i]]$name
  city <- subset[[i]]$city$name
  address <- subset[[i]]$address$line1
  postalCode <- subset[[i]]$postalCode
  countryCode <- subset[[i]]$country$countryCode
  url <- subset[[i]]$url
  longitude <- subset[[i]]$location$longitude
  latitude <- subset[[i]]$location$latitude
  
  venues[i, ] <- c(name, city, address, postalCode, countryCode, url, 
                   longitude, latitude)
}

```


# Interacting with the API - advanced

Extract the venues from the other pages

```{r advanced, message=F}

# entries per page
size <- venuesResp[["page"]][["size"]]

# get number of pages
pages <- venuesResp[["page"]][["totalPages"]]

# number of elements to check after the loop
elements <- venuesResp[["page"]][["totalElements"]]

for (j in 1:pages){
  venuesResp2 <- GET(paste0(root, "venues?apikey=", mykey, 
                     "&locale=*&page=", j, "&countryCode=", country)) %>% 
    content()
  
  # subset list to venue data
  subset <- venuesResp2[["_embedded"]][["venues"]]
  
  venues2 <- data.frame(name = character(size),
                     city = character(size), 
                     adress = character(size),
                     postalCode = integer(size),
                     countryCode = character(size),
                     url = character(size),
                     longitude = numeric(size),
                     latitude = numeric(size),
                     stringsAsFactors=FALSE)
  
  for (i in 1:size){
  name <- ifelse(is.null(subset[[i]]$name), NA, subset[[i]]$name)
  city <- ifelse(is.null(subset[[i]]$city$name), NA, subset[[i]]$city$name)
  address <- ifelse(is.null(subset[[i]]$address$line1), NA, subset[[i]]$address$line1)
  postalCode <- ifelse(is.null(subset[[i]]$postalCode), NA, subset[[i]]$postalCode)
  countryCode <- ifelse(is.null(subset[[i]]$country$countryCode), NA,
                        subset[[i]]$country$countryCode)
  url <- ifelse(is.null(subset[[i]]$url), NA, subset[[i]]$url)
  longitude <- ifelse(is.null(subset[[i]]$location$longitude), NA,
                      subset[[i]]$location$longitude)
  latitude <- ifelse(is.null(subset[[i]]$location$latitude), NA,
                     subset[[i]]$location$latitude)
  
  venues2[i , ] <- c(name, city, address, postalCode, countryCode, url, 
                   longitude, latitude)
  }
  venues <- rbind(venues, venues2)
}

# check for correctness
dim(venues)[1] - elements


```




```{r viz, message=F}

library(ggplot2)

# change format for filtering
venues$longitude <- as.numeric(venues$longitude)
venues$latitude <- as.numeric(venues$latitude)

# only select the ones in the coordinate range
venuesDE <- filter(venues, longitude > 5.866944 & longitude < 15.043611 &
                     latitude > 47.271679 & latitude < 55.0846)

# using the code given in task
mapDE <- ggplot() + geom_polygon(
  aes(x = long, y = lat, group = group), data = map_data("world", region = countryLong),
  fill = "grey90",color = "black") +
  theme_void() + coord_quickmap() +
  geom_point(data = venuesDE, aes(x = longitude, y = latitude), size = 1, 
        shape = 23, fill = "darkred") +
  labs(title = paste0("Event locations across ", countryLong), 
       caption = "Source: ticketmaster.com") +
  theme(title = element_text(size=8, face='bold'),
        plot.caption = element_text(face = "italic"))
mapDE


```




```{r key, message=F}



```








